{
  "info": {
    "name": "FitnessReservation Smoke",
    "_postman_id": "9f0f2a7c-7d8a-4a5a-9e4a-5a2f25c0b2b7",
    "description": "Smoke tests: health, pricing, register/login/me, list sessions, reserve.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "exec": [
          "pm.variables.set('username', 'u_' + pm.variables.replaceIn('{{$guid}}').replace(/-/g,''));",
          "pm.variables.set('password', 'P@ssw0rd-1');",
          "pm.variables.set('sport', 'Yoga');",
          "pm.variables.set('sessionId', '11111111-1111-1111-1111-111111111111');"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "GET /health",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/health"
      },
      "event": [
        {
          "listen": "test",
          "script": { "exec": [ "pm.test('status 200', () => pm.response.to.have.status(200));" ] }
        }
      ]
    },
    {
      "name": "POST /pricing/calculate",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"sport\": \"Yoga\",\n  \"membership\": \"Standard\",\n  \"isPeak\": true,\n  \"occupancy\": \"High\"\n}\n"
        },
        "url": "{{baseUrl}}/pricing/calculate"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 200', () => pm.response.to.have.status(200));",
              "const b = pm.response.json();",
              "pm.test('finalPrice > 0', () => pm.expect(b.finalPrice).to.be.above(0));"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/register (Standard)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"{{username}}\",\n  \"password\": \"{{password}}\",\n  \"membershipType\": \"Standard\",\n  \"membershipCode\": null\n}\n"
        },
        "url": "{{baseUrl}}/auth/register"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 201', () => pm.response.to.have.status(201));",
              "const b = pm.response.json();",
              "pm.test('memberId exists', () => pm.expect(b.memberId).to.be.ok);"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/login",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"{{username}}\",\n  \"password\": \"{{password}}\"\n}\n"
        },
        "url": "{{baseUrl}}/auth/login"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 200', () => pm.response.to.have.status(200));",
              "const b = pm.response.json();",
              "pm.test('membershipType is Standard', () => pm.expect(b.membershipType).to.eql('Standard'));"
            ]
          }
        }
      ]
    },
    {
      "name": "GET /me (after login)",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/me"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 200', () => pm.response.to.have.status(200));",
              "const b = pm.response.json();",
              "pm.test('username matches', () => pm.expect(b.username).to.eql(pm.variables.get('username')));"
            ]
          }
        }
      ]
    },
    {
      "name": "GET /sessions?sport=Yoga&from..to..",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/sessions?sport={{sport}}&from={{fromUtc}}&to={{toUtc}}",
          "host": [ "{{baseUrl}}" ],
          "path": [ "sessions" ],
          "query": [
            {
              "key": "sport",
              "value": "{{sport}}"
            },
            {
              "key": "from",
              "value": "{{fromUtc}}"
            },
            {
              "key": "to",
              "value": "{{toUtc}}"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "const from = new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString();",
              "const to = new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString();",
              "pm.variables.set('fromUtc', from);",
              "pm.variables.set('toUtc', to);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 200', () => pm.response.to.have.status(200));",
              "const items = pm.response.json();",
              "pm.test('returns array', () => pm.expect(items).to.be.an('array'));",
              "pm.test('has price.finalPrice', () => { if (items.length) pm.expect(items[0].price.finalPrice).to.be.above(0); });"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /reservations (reserve session)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"sessionId\": \"{{sessionId}}\"\n}\n"
        },
        "url": "{{baseUrl}}/reservations"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status 201', () => pm.response.to.have.status(201));",
              "const b = pm.response.json();",
              "pm.test('reservationId exists', () => pm.expect(b.reservationId).to.be.ok);",
              "pm.test('finalPrice > 0', () => pm.expect(b.finalPrice).to.be.above(0));"
            ]
          }
        }
      ]
    }
  ]
}

name: CI (Full Quality & Resilience Gate)

on:
  push:
    branches: [ "master", "apiv1.2", "backend" ]
  pull_request:
    branches: [ "master", "apiv1.2", "backend" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. .NET Ortamý, Derleme ve Unit Testler
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build Project
        run: dotnet build -c Release --no-restore

      - name: Run Unit Tests with Coverage
        run: dotnet test -c Release --no-build --verbosity normal --collect:"XPlat Code Coverage"

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate Coverage Report (HTML)
        run: reportgenerator "-reports:**/coverage.cobertura.xml" "-targetdir:coverage-report" "-reporttypes:Html"

      # 2. Node.js ve Newman (Postman) Hazýrlýðý
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Newman
        run: npm install -g newman

      # 3. Dockerize Etme ve API Baþlatma (Path Hatasýný Çözer)
      - name: Build Docker Image
        run: docker build -t fitness-reservation-api .

      - name: Create Data Directory & Start Container
        run: |
          mkdir -p data
          chmod 777 data
          docker run -d -p 7001:7001 --name fitness-app \
            -v $(pwd)/data:/app/data \
            fitness-reservation-api

      - name: Wait for API Health Check
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:7001/health; then
              echo "API is up and running!"
              exit 0
            fi
            echo "Waiting for API..."
            sleep 2
          done
          echo "API failed to start"
          docker logs fitness-app
          exit 1

      # 4. Newman (Postman) Entegrasyon Testleri
      - name: Run Newman Tests
        run: |
          mkdir -p postman/out
          newman run postman/FitnessReservation.postman_collection.json \
            -e postman/FitnessReservation.ci.postman_environment.json \
            --reporters cli,junit \
            --reporter-junit-export postman/out/newman-junit-${{ github.run_id }}.xml

      # 5. ZAP Active Security Scan (Full Scan)
      - name: ZAP Active Scan
        run: |
          mkdir -p zap
          chmod 777 zap
          docker run --rm --network host \
            -v $(pwd)/zap:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:7001 -r zap_active_report.html || true

      # 6. Chaos Engineering & Performance (k6)
      - name: Install k6
        run: |
          curl -sSL -o k6.tar.gz https://github.com/grafana/k6/releases/download/v0.50.0/k6-v0.50.0-linux-amd64.tar.gz
          tar -xzf k6.tar.gz
          sudo mv k6-v0.50.0-linux-amd64/k6 /usr/local/bin/k6

      - name: Run Chaos & Performance Test
        run: |
          # Pumba'yý arka planda baþlat (Kaos Maymunu)
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            gaiaadm/pumba --interval 15s stop --duration 5s --restart fitness-app &
          
          # Kaos sürerken k6 performans testini çalýþtýr
          mkdir -p k6-results
          k6 run --vus 5 --duration 20s --summary-export k6-results/summary.json k6/journey.js

      # 7. Tüm Raporlarý Artifact Olarak Yükleme
      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Full-Project-Test-Reports
          path: |
            coverage-report/
            postman/out/
            zap/zap_active_report.html
            k6-results/
          retention-days: 7

      - name: Upload Docker Logs on Failure
        if: failure()
        run: docker logs fitness-app > docker-api-fail.log

      - name: Upload Fail Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs
          path: docker-api-fail.log